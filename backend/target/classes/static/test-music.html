<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音乐播放器测试</title>
    <link rel="stylesheet" href="css/style.css?v=4.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div style="padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh;">
        <h1 style="color: white; text-align: center; margin-bottom: 30px;">音乐播放器功能测试</h1>
        
        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
            <h3 style="color: white;">测试说明：</h3>
            <ul style="color: white;">
                <li>音乐播放器应该出现在页面右上角</li>
                <li>可以拖拽移动播放器位置</li>
                <li>点击减号按钮可以收缩为图标</li>
                <li>点击加号按钮可以展开完整界面</li>
                <li>可以播放music文件夹中的MP3文件</li>
            </ul>
        </div>

        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px;">
            <h3 style="color: white;">可用的音乐文件：</h3>
            <ul style="color: white;">
                <li>book.mp3 - 读书声</li>
                <li>fire.mp3 - 篝火声</li>
                <li>rain.mp3 - 雨声</li>
                <li>ware.mp3 - 仓库声</li>
            </ul>
        </div>
    </div>

    <!-- 音乐播放器悬浮窗 -->
    <div id="musicPlayer" class="music-player">
        <div class="music-player-header">
            <div class="music-player-title">
                <i class="fas fa-music"></i>
                <span>音乐播放器</span>
            </div>
            <div class="music-player-controls">
                <button id="musicPlayerToggle" class="btn-icon" title="收缩/展开">
                    <i class="fas fa-minus"></i>
                </button>
                <button id="musicPlayerClose" class="btn-icon" title="关闭">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <div class="music-player-content">
            <div class="music-info">
                <div class="music-cover">
                    <i class="fas fa-music"></i>
                </div>
                <div class="music-details">
                    <div class="music-name" id="currentMusicName">选择音乐</div>
                    <div class="music-artist" id="currentMusicArtist">未知艺术家</div>
                </div>
            </div>
            
            <div class="music-controls">
                <button id="prevMusic" class="btn-icon" title="上一首">
                    <i class="fas fa-step-backward"></i>
                </button>
                <button id="playPauseMusic" class="btn-icon btn-play" title="播放/暂停">
                    <i class="fas fa-play"></i>
                </button>
                <button id="nextMusic" class="btn-icon" title="下一首">
                    <i class="fas fa-step-forward"></i>
                </button>
            </div>
            
            <div class="music-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="musicProgressFill"></div>
                </div>
                <div class="time-display">
                    <span id="currentTime">0:00</span>
                    <span id="totalTime">0:00</span>
                </div>
            </div>
            
            <div class="music-volume">
                <i class="fas fa-volume-down"></i>
                <input type="range" id="volumeSlider" min="0" max="100" value="50" class="volume-slider">
                <i class="fas fa-volume-up"></i>
            </div>
            
            <div class="music-list">
                <div class="music-list-header">
                    <span>播放列表</span>
                    <button id="toggleMusicList" class="btn-icon" title="展开/收起列表">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                <div class="music-list-content" id="musicListContent">
                    <!-- 音乐列表将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // 简化的音乐播放器类
        class SimpleMusicPlayer {
            constructor() {
                this.audio = null;
                this.currentTrack = 0;
                this.isPlaying = false;
                this.isCollapsed = false;
                this.isListExpanded = false;
                this.volume = 0.5;
                this.tracks = [
                    { name: '读书声', artist: '环境音效', file: 'music/book.mp3' },
                    { name: '篝火声', artist: '环境音效', file: 'music/fire.mp3' },
                    { name: '雨声', artist: '环境音效', file: 'music/rain.mp3' },
                    { name: '仓库声', artist: '环境音效', file: 'music/ware.mp3' }
                ];

                this.init();
            }

            init() {
                this.bindEvents();
                this.renderMusicList();
                this.updateMusicInfo();
                this.makeDraggable();
            }

            bindEvents() {
                // 收缩/展开按钮
                const toggleBtn = document.getElementById('musicPlayerToggle');
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', () => {
                        this.togglePlayer();
                    });
                }

                // 关闭按钮
                const closeBtn = document.getElementById('musicPlayerClose');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        this.closePlayer();
                    });
                }

                // 播放/暂停按钮
                const playPauseBtn = document.getElementById('playPauseMusic');
                if (playPauseBtn) {
                    playPauseBtn.addEventListener('click', () => {
                        this.togglePlayPause();
                    });
                }

                // 上一首按钮
                const prevBtn = document.getElementById('prevMusic');
                if (prevBtn) {
                    prevBtn.addEventListener('click', () => {
                        this.previousTrack();
                    });
                }

                // 下一首按钮
                const nextBtn = document.getElementById('nextMusic');
                if (nextBtn) {
                    nextBtn.addEventListener('click', () => {
                        this.nextTrack();
                    });
                }

                // 音量滑块
                const volumeSlider = document.getElementById('volumeSlider');
                if (volumeSlider) {
                    volumeSlider.addEventListener('input', (e) => {
                        this.setVolume(e.target.value / 100);
                    });
                }

                // 进度条点击
                const progressBar = document.querySelector('.progress-bar');
                if (progressBar) {
                    progressBar.addEventListener('click', (e) => {
                        this.seekTo(e);
                    });
                }

                // 播放列表切换
                const toggleListBtn = document.getElementById('toggleMusicList');
                if (toggleListBtn) {
                    toggleListBtn.addEventListener('click', () => {
                        this.toggleMusicList();
                    });
                }
            }

            makeDraggable() {
                const player = document.getElementById('musicPlayer');
                const header = document.querySelector('.music-player-header');
                
                if (!player || !header) return;

                let isDragging = false;
                let startX, startY, startLeft, startTop;

                // 确保播放器有初始位置
                if (!player.style.left && !player.style.top) {
                    player.style.position = 'fixed';
                    player.style.left = '20px';
                    player.style.top = '20px';
                }

                header.addEventListener('mousedown', (e) => {
                    if (e.target.closest('button')) return;
                    
                    e.preventDefault();
                    isDragging = true;
                    
                    startX = e.clientX;
                    startY = e.clientY;
                    
                    const rect = player.getBoundingClientRect();
                    startLeft = rect.left;
                    startTop = rect.top;
                    
                    player.style.position = 'fixed';
                    player.style.left = startLeft + 'px';
                    player.style.top = startTop + 'px';
                    player.style.cursor = 'grabbing';
                    
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                });

                const handleMouseMove = (e) => {
                    if (!isDragging) return;
                    
                    e.preventDefault();
                    
                    const deltaX = e.clientX - startX;
                    const deltaY = e.clientY - startY;
                    
                    const newLeft = startLeft + deltaX;
                    const newTop = startTop + deltaY;
                    
                    const maxLeft = window.innerWidth - player.offsetWidth;
                    const maxTop = window.innerHeight - player.offsetHeight;
                    
                    player.style.left = Math.max(0, Math.min(newLeft, maxLeft)) + 'px';
                    player.style.top = Math.max(0, Math.min(newTop, maxTop)) + 'px';
                };

                const handleMouseUp = () => {
                    if (!isDragging) return;
                    
                    isDragging = false;
                    player.style.cursor = 'default';
                    
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                };
            }

            togglePlayer() {
                const player = document.getElementById('musicPlayer');
                const toggleIcon = document.querySelector('#musicPlayerToggle i');
                
                if (!player || !toggleIcon) return;

                this.isCollapsed = !this.isCollapsed;
                
                if (this.isCollapsed) {
                    player.classList.add('collapsed');
                    toggleIcon.className = 'fas fa-plus';
                    console.log('音乐播放器已收缩');
                    
                    // 为收缩状态添加点击展开功能
                    this.addCollapsedClickHandler();
                } else {
                    player.classList.remove('collapsed');
                    toggleIcon.className = 'fas fa-minus';
                    console.log('音乐播放器已展开');
                    
                    // 移除收缩状态的点击事件
                    this.removeCollapsedClickHandler();
                }
            }

            // 添加收缩状态点击展开功能
            addCollapsedClickHandler() {
                const player = document.getElementById('musicPlayer');
                if (!player) return;

                // 移除之前的事件监听器（如果存在）
                this.removeCollapsedClickHandler();

                // 添加新的点击事件监听器
                this.collapsedClickHandler = (e) => {
                    // 如果点击的不是按钮，则展开播放器
                    if (!e.target.closest('button')) {
                        this.togglePlayer();
                    }
                };

                player.addEventListener('click', this.collapsedClickHandler);
            }

            // 移除收缩状态点击事件
            removeCollapsedClickHandler() {
                const player = document.getElementById('musicPlayer');
                if (!player || !this.collapsedClickHandler) return;

                player.removeEventListener('click', this.collapsedClickHandler);
                this.collapsedClickHandler = null;
            }

            closePlayer() {
                const player = document.getElementById('musicPlayer');
                if (player) {
                    player.style.display = 'none';
                }
                
                if (this.audio) {
                    this.audio.pause();
                    this.audio = null;
                }
            }

            togglePlayPause() {
                console.log('切换播放/暂停，当前状态:', this.isPlaying);
                
                if (!this.audio) {
                    console.log('没有音频对象，加载当前曲目');
                    this.loadCurrentTrack();
                    return;
                }

                if (this.isPlaying) {
                    console.log('当前正在播放，执行暂停');
                    this.pauseMusic();
                } else {
                    console.log('当前已暂停，执行播放');
                    this.playMusic();
                }
            }

            playMusic() {
                if (!this.audio) {
                    console.log('没有音频对象，无法播放');
                    return;
                }

                console.log('开始播放音乐');
                this.audio.play().then(() => {
                    this.isPlaying = true;
                    this.updatePlayButton();
                    console.log('播放成功，状态已更新');
                }).catch(error => {
                    console.error('播放失败:', error);
                    this.isPlaying = false;
                    this.updatePlayButton();
                    alert('播放失败，请检查音频文件');
                });
            }

            pauseMusic() {
                if (!this.audio) {
                    console.log('没有音频对象，无法暂停');
                    return;
                }

                console.log('暂停音乐');
                this.audio.pause();
                this.isPlaying = false;
                this.updatePlayButton();
                console.log('暂停成功，状态已更新');
            }

            loadCurrentTrack() {
                const track = this.tracks[this.currentTrack];
                if (!track) return;

                // 停止当前播放的音频
                if (this.audio) {
                    this.audio.pause();
                    this.audio = null;
                }

                this.audio = new Audio(track.file);
                this.audio.volume = this.volume;
                
                this.audio.addEventListener('loadedmetadata', () => {
                    this.updateTimeDisplay();
                });

                this.audio.addEventListener('timeupdate', () => {
                    this.updateProgress();
                });

                this.audio.addEventListener('ended', () => {
                    this.nextTrack();
                });

                this.audio.addEventListener('error', (e) => {
                    console.error('音频加载失败:', e);
                    alert('音频文件加载失败');
                });

                this.updateMusicInfo();
                this.updatePlayButton();
            }

            previousTrack() {
                console.log('切换到上一首');
                // 先停止当前播放
                if (this.audio && this.isPlaying) {
                    this.audio.pause();
                }
                
                this.currentTrack = (this.currentTrack - 1 + this.tracks.length) % this.tracks.length;
                this.isPlaying = false; // 切换歌曲后默认暂停
                this.loadCurrentTrack();
                this.updateMusicList();
            }

            nextTrack() {
                console.log('切换到下一首');
                // 先停止当前播放
                if (this.audio && this.isPlaying) {
                    this.audio.pause();
                }
                
                this.currentTrack = (this.currentTrack + 1) % this.tracks.length;
                this.isPlaying = false; // 切换歌曲后默认暂停
                this.loadCurrentTrack();
                this.updateMusicList();
            }

            setVolume(volume) {
                this.volume = volume;
                if (this.audio) {
                    this.audio.volume = volume;
                }
            }

            seekTo(event) {
                if (!this.audio) return;

                const progressBar = event.currentTarget;
                const rect = progressBar.getBoundingClientRect();
                const clickX = event.clientX - rect.left;
                const percentage = clickX / rect.width;
                const newTime = percentage * this.audio.duration;
                
                this.audio.currentTime = newTime;
            }

            toggleMusicList() {
                const listContent = document.getElementById('musicListContent');
                const toggleIcon = document.querySelector('#toggleMusicList i');
                
                if (!listContent) return;

                this.isListExpanded = !this.isListExpanded;
                
                if (this.isListExpanded) {
                    listContent.classList.add('show');
                    toggleIcon.className = 'fas fa-chevron-up';
                } else {
                    listContent.classList.remove('show');
                    toggleIcon.className = 'fas fa-chevron-down';
                }
            }

            renderMusicList() {
                const listContent = document.getElementById('musicListContent');
                if (!listContent) return;

                listContent.innerHTML = this.tracks.map((track, index) => `
                    <div class="music-item ${index === this.currentTrack ? 'active' : ''}" 
                         onclick="musicPlayer.selectTrack(${index})">
                        <i class="fas fa-music"></i>
                        <span>${track.name}</span>
                    </div>
                `).join('');
            }

            selectTrack(index) {
                console.log('选择曲目:', index);
                // 先停止当前播放
                if (this.audio && this.isPlaying) {
                    this.audio.pause();
                }
                
                this.currentTrack = index;
                this.isPlaying = false; // 切换歌曲后默认暂停
                this.loadCurrentTrack();
                this.updateMusicList();
            }

            updateMusicInfo() {
                const track = this.tracks[this.currentTrack];
                if (!track) return;

                const nameElement = document.getElementById('currentMusicName');
                const artistElement = document.getElementById('currentMusicArtist');
                
                if (nameElement) nameElement.textContent = track.name;
                if (artistElement) artistElement.textContent = track.artist;
            }

            updatePlayButton() {
                const playIcon = document.querySelector('#playPauseMusic i');
                if (!playIcon) return;

                if (this.isPlaying) {
                    playIcon.className = 'fas fa-pause';
                } else {
                    playIcon.className = 'fas fa-play';
                }
            }

            updateProgress() {
                if (!this.audio) return;

                const progressFill = document.getElementById('musicProgressFill');
                if (progressFill) {
                    const percentage = (this.audio.currentTime / this.audio.duration) * 100;
                    progressFill.style.width = percentage + '%';
                }

                this.updateTimeDisplay();
            }

            updateTimeDisplay() {
                if (!this.audio) return;

                const currentTimeElement = document.getElementById('currentTime');
                const totalTimeElement = document.getElementById('totalTime');
                
                if (currentTimeElement) {
                    currentTimeElement.textContent = this.formatTime(this.audio.currentTime);
                }
                
                if (totalTimeElement) {
                    totalTimeElement.textContent = this.formatTime(this.audio.duration);
                }
            }

            formatTime(seconds) {
                if (isNaN(seconds)) return '0:00';
                
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            updateMusicList() {
                const items = document.querySelectorAll('.music-item');
                items.forEach((item, index) => {
                    if (index === this.currentTrack) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
            }
        }

        // 初始化音乐播放器
        let musicPlayer;
        document.addEventListener('DOMContentLoaded', function() {
            musicPlayer = new SimpleMusicPlayer();
        });
    </script>
</body>
</html>
